<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Daily Agent - ç”¨æˆ·äº¤äº’æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }

        /* é»‘è‰²å…¨å±å®¹å™¨ */
        .fullscreen-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
        }

        /* å·¦ä¸Šè§’é€‰æ‹©å™¨æŒ‰é’® */
        .selector-toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .selector-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* é€‰æ‹©å™¨é¢æ¿ - å·¦ä¸Šè§’ */
        .selector-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 340px;
            max-height: 90vh;
            overflow-y: auto;
            background: #1d1d1f;
            padding: 20px;
            border-radius: 0 0 16px 16px 0;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .selector-panel.active {
            display: block;
        }

        .selector-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .selector-close {
            position: absolute;
            top: 16px;
            right: 20px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0 8px;
        }

        .selector-close:hover {
            color: #f5f5f7;
        }

        .selector-section {
            margin-bottom: 24px;
        }

        .selector-section-title {
            font-size: 14px;
            color: #c7c7cc;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .selector-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }

        .selector-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .selector-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .selector-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .selector-item-name {
            font-size: 14px;
            color: #fff;
            margin-bottom: 4px;
        }

        .selector-item-date {
            font-size: 12px;
            color: #c7c7cc;
        }

        .selector-item.selected .selector-item-date {
            color: rgba(255, 255, 255, 0.8);
        }

        .selector-btn {
            width: 100%;
            padding: 14px 24px;
            background: #fff;
            color: #1d1d1f;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .selector-btn:hover {
            background: #e5e5e7;
        }

        .selector-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åˆ‡æ¢æŒ‰é’® - å³ä¸Šè§’ */
        .mode-switch-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .mode-switch-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* æ‰‹æœºæ¡†æ¶ - ç«–å± 9:16 */
        .phone-frame {
            width: 360px;
            height: 640px;
            max-height: 95vh;
            aspect-ratio: 9 / 16;
            background: #1c1c1e;
            border-radius: 24px;
            border: 6px solid #2c2c2e;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.8),
                        inset 0 0 0 2px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* æ‰‹æœºå°ºå¯¸é€‰æ‹©èœå• - å³ä¸‹è§’ */
        .size-menu-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .size-menu-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* å°ºå¯¸é€‰æ‹©é¢æ¿ */
        .size-menu-panel {
            position: fixed;
            bottom: 70px;
            right: 20px;
            z-index: 998;
            background: #1d1d1f;
            border-radius: 12px;
            padding: 12px;
            min-width: 180px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .size-menu-panel.active {
            display: block;
        }

        .size-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }

        .size-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .size-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .size-option-name {
            font-size: 14px;
            color: #fff;
        }

        .size-option-dims {
            font-size: 11px;
            color: #8e8e93;
        }

        .size-option.selected .size-option-dims {
            color: rgba(255, 255, 255, 0.8);
        }

        /* æ‰‹æœºæ¡†æ¶å°ºå¯¸å˜ä½“ */
        .phone-frame.size-iphone4 {
            width: 320px;
            height: 480px;
        }

        .phone-frame.size-iphone5 {
            width: 320px;
            height: 568px;
        }

        .phone-frame.size-iphone6 {
            width: 375px;
            height: 667px;
        }

        .phone-frame.size-iphone6plus {
            width: 414px;
            height: 736px;
        }

        .phone-frame.size-iphonex {
            width: 375px;
            height: 812px;
        }

        .phone-frame.size-iphonexr {
            width: 414px;
            height: 896px;
        }

        .phone-frame.size-iphone12 {
            width: 390px;
            height: 844px;
        }

        .phone-frame.size-iphone12pm {
            width: 428px;
            height: 926px;
        }

        .phone-frame.size-iphone14pro {
            width: 393px;
            height: 852px;
        }

        .phone-frame.size-iphone15pm {
            width: 430px;
            height: 932px;
        }

        .phone-frame.size-android {
            width: 360px;
            height: 640px;
        }

        /* è§†é¢‘ä¼˜å…ˆå°ºå¯¸ - è‡ªé€‚åº”é«˜åº¦ï¼Œæ— éœ€æ»šåŠ¨ */
        .phone-frame.size-video {
            width: 360px;
            height: auto;
            max-height: 95vh;
            max-width: 95vw;
        }

        .phone-frame.size-full {
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
            border: none;
        }

        /* çŠ¶æ€æ  - æ‚¬æµ®é€æ˜ï¼Œåœ¨è§†é¢‘ä¸Šæ–¹ */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            padding: 12px 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
            z-index: 100;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .character-name {
            font-size: 14px;
            font-weight: 600;
        }

        .mood-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 12px;
            margin-left: 4px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            opacity: 0.9;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-value {
            font-weight: 600;
            color: #fff;
        }

        .status-label {
            color: #8e8e93;
            font-size: 11px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒå¯æ»šåŠ¨ */
        .content-area::-webkit-scrollbar {
            width: 0;
            display: none;
        }

        /* å¼€å§‹é¡µé¢ */
        .start-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 54px 24px 40px 24px;  /* é¡¶éƒ¨ç•™å‡ºç©ºé—´ç»™æ‚¬æµ®çŠ¶æ€æ  */
            text-align: center;
        }

        .start-screen h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .start-screen .subtitle {
            font-size: 14px;
            color: #8e8e93;
            margin-bottom: 32px;
        }

        .character-info {
            background: #1c1c1e;
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            margin-bottom: 24px;
        }

        .character-info .label {
            font-size: 12px;
            color: #8e8e93;
            margin-bottom: 4px;
        }

        .character-info .value {
            font-size: 18px;
            font-weight: 500;
        }

        .start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px -10px rgba(102, 126, 234, 0.5);
        }

        .start-btn:disabled {
            background: #3a3a3c;
            cursor: not-allowed;
            transform: none;
        }

        /* è§†é¢‘æ’­æ”¾åŒºåŸŸ */
        .video-container {
            width: 100%;
            aspect-ratio: 9 / 16;
            background: #000;
            position: relative;
            flex-shrink: 0;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* é€‰é¡¹åŒºåŸŸ - åœ¨ä¸Šé¢ï¼Œé¿å¼€çŠ¶æ€æ  */
        .choices-section {
            padding: 16px;
            padding-top: 60px;  /* é¿å¼€æ‚¬æµ®çš„çŠ¶æ€æ  (44px + 16px) */
            background: #000;
            flex-shrink: 0;
        }

        .choice-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            background: #2c2c2e;
            border: 2px solid transparent;
            border-radius: 14px;
            color: #fff;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .choice-btn:hover {
            background: #3a3a3c;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .choice-btn .choice-id {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .choice-btn .choice-tag {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
            color: #aeaeb2;
        }

        .choice-btn .choice-action {
            font-size: 12px;
            color: #8e8e93;
        }

        /* å‰§æƒ…ä¿¡æ¯åŒºåŸŸ - åœ¨ä¸‹é¢ */
        .story-section {
            padding: 16px;
            background: #1c1c1e;
            flex: 1;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .event-time {
            font-size: 13px;
            color: #8e8e93;
        }

        .event-type-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
        }

        .type-n { background: #3a3a3c; color: #8e8e93; }
        .type-r { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .type-sr { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

        .story-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .story-text {
            font-size: 13px;
            color: #aeaeb2;
            line-height: 1.6;
        }

        /* ç»“å±€æ˜¾ç¤º - åœ¨è§†é¢‘å®¹å™¨å†…ã€è§†é¢‘ä¸‹æ–¹ï¼Œé€æ˜èƒŒæ™¯ */
        .ending-section {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 20px;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
            text-align: center;
        }

        .ending-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ending-text {
            font-size: 14px;
            color: #fff;
            line-height: 1.7;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        /* è§†é¢‘å®¹å™¨ - éœ€è¦ç›¸å¯¹å®šä½ä»¥å®¹çº³ç»“å±€ */
        .video-container {
            position: relative;
        }

        /* è§†é¢‘å®¹å™¨ - ç”¨äºç»“å±€å®šæ ¼ */
        .video-container.freeze-blur video {
            filter: blur(8px);
            transition: filter 1s ease;
        }

        /* è§†é¢‘å®¹å™¨ç”¨äºç»“å±€è¦†ç›–å±‚ */
        .video-container.has-ending {
            position: relative;
        }

        /* ç»§ç»­æŒ‰é’® - éšè—ï¼Œè‡ªåŠ¨ç»§ç»­ */
        .continue-btn {
            display: none !important;
        }

        /* å®Œæˆé¡µé¢ */
        .complete-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
        }

        .complete-screen .emoji {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .complete-screen h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .final-stats {
            background: #1c1c1e;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            margin-bottom: 24px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2c2c2e;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #8e8e93;
            font-size: 14px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 500;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ - æ‚¬æµ®é€æ˜ï¼Œåœ¨é€‰é¡¹ä¸‹æ–¹ */
        .progress-dots {
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            gap: 6px;
            padding: 8px 16px;
            justify-content: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 50%, transparent 100%);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3a3a3c;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .progress-dot.completed {
            background: #764ba2;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2c2c2e;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡éšè— */
        .content-area::-webkit-scrollbar {
            width: 0;
            display: none;
        }

        /* æ·¡å…¥åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¸Šè§’é€‰æ‹©å™¨æŒ‰é’® -->
    <button class="selector-toggle-btn" onclick="toggleSelector()">
        â˜°
    </button>

    <!-- é€‰æ‹©å™¨é¢æ¿ -->
    <div class="selector-panel" id="selectorPanel">
        <button class="selector-close" onclick="toggleSelector()">Ã—</button>
        <h2 class="selector-title">é€‰æ‹©è§’è‰²å’Œæ—¥æœŸ</h2>

        <div class="selector-section">
            <div class="selector-section-title">é€‰æ‹©è§’è‰²</div>
            <div class="selector-grid" id="characterGrid">
                <!-- è§’è‰²åˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="selector-section">
            <div class="selector-section-title">é€‰æ‹©æ—¥æœŸ</div>
            <div class="selector-grid" id="dateGrid">
                <!-- æ—¥æœŸåˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <button class="selector-btn" id="confirmBtn" onclick="confirmSelection()" disabled>ç¡®è®¤é€‰æ‹©</button>
    </div>

    <!-- åˆ‡æ¢æŒ‰é’® - å³ä¸Šè§’ -->
    <button class="mode-switch-btn" onclick="switchToDebugMode()">
        &larr; è°ƒè¯•æ¨¡å¼
    </button>

    <!-- æ‰‹æœºå°ºå¯¸é€‰æ‹©æŒ‰é’® - å³ä¸‹è§’ -->
    <button class="size-menu-btn" onclick="toggleSizeMenu()">
        ğŸ“± å°ºå¯¸
    </button>

    <!-- å°ºå¯¸é€‰æ‹©é¢æ¿ -->
    <div class="size-menu-panel" id="sizeMenuPanel">
        <div class="size-option selected" data-size="video" onclick="selectPhoneSize('video')">
            <span class="size-option-name">â­ è§†é¢‘ä¼˜å…ˆ (æ— æ»šåŠ¨)</span>
            <span class="size-option-dims">è‡ªé€‚åº”</span>
        </div>
        <div class="size-option" data-size="iphone4" onclick="selectPhoneSize('iphone4')">
            <span class="size-option-name">iPhone 4</span>
            <span class="size-option-dims">320Ã—480</span>
        </div>
        <div class="size-option" data-size="iphone5" onclick="selectPhoneSize('iphone5')">
            <span class="size-option-name">iPhone 5 / SE</span>
            <span class="size-option-dims">320Ã—568</span>
        </div>
        <div class="size-option" data-size="iphone6" onclick="selectPhoneSize('iphone6')">
            <span class="size-option-name">iPhone 6 / 7 / 8</span>
            <span class="size-option-dims">375Ã—667</span>
        </div>
        <div class="size-option" data-size="iphone6plus" onclick="selectPhoneSize('iphone6plus')">
            <span class="size-option-name">iPhone 6+ / 7+ / 8+</span>
            <span class="size-option-dims">414Ã—736</span>
        </div>
        <div class="size-option" data-size="iphonex" onclick="selectPhoneSize('iphonex')">
            <span class="size-option-name">iPhone X / XS / 11 Pro</span>
            <span class="size-option-dims">375Ã—812</span>
        </div>
        <div class="size-option" data-size="iphonexr" onclick="selectPhoneSize('iphonexr')">
            <span class="size-option-name">iPhone XR / 11</span>
            <span class="size-option-dims">414Ã—896</span>
        </div>
        <div class="size-option" data-size="iphone12" onclick="selectPhoneSize('iphone12')">
            <span class="size-option-name">iPhone 12 / 13 / 14</span>
            <span class="size-option-dims">390Ã—844</span>
        </div>
        <div class="size-option" data-size="iphone12pm" onclick="selectPhoneSize('iphone12pm')">
            <span class="size-option-name">iPhone 12 Pro Max</span>
            <span class="size-option-dims">428Ã—926</span>
        </div>
        <div class="size-option" data-size="iphone14pro" onclick="selectPhoneSize('iphone14pro')">
            <span class="size-option-name">iPhone 14 Pro / 15 Pro</span>
            <span class="size-option-dims">393Ã—852</span>
        </div>
        <div class="size-option" data-size="iphone15pm" onclick="selectPhoneSize('iphone15pm')">
            <span class="size-option-name">iPhone 15 Pro Max</span>
            <span class="size-option-dims">430Ã—932</span>
        </div>
        <div class="size-option" data-size="android" onclick="selectPhoneSize('android')">
            <span class="size-option-name">Android æ ‡å‡†</span>
            <span class="size-option-dims">360Ã—640</span>
        </div>
        <div class="size-option" data-size="full" onclick="selectPhoneSize('full')">
            <span class="size-option-name">å…¨å±æ˜¾ç¤º</span>
            <span class="size-option-dims">100%</span>
        </div>
    </div>

    <div class="fullscreen-container">
        <div class="phone-frame size-video">
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="status-left">
                    <span class="character-name" id="statusCharacter">{{ character }}</span>
                    <span class="mood-badge" id="statusMoodBadge">{{ mood }}</span>
                </div>
                <div class="status-right">
                    <div class="status-item">
                        <span class="status-label">âš¡</span>
                        <span class="status-value" id="statusEnergy">{{ energy }}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">â¤ï¸</span>
                        <span class="status-value" id="statusIntimacy">0</span>
                    </div>
                </div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area" id="contentArea">
                <!-- å¼€å§‹ç•Œé¢ -->
                <div class="start-screen" id="startScreen">
                    <h1>Character Daily Agent</h1>
                    <p class="subtitle">æ²‰æµ¸å¼å½±æ¸¸ä½“éªŒ</p>

                    <div class="character-info">
                        <div class="label">è§’è‰²</div>
                        <div class="value" id="startCharacter">{{ character }}</div>
                    </div>

                    <div class="character-info">
                        <div class="label">æ—¥æœŸ</div>
                        <div class="value" id="startDate">{{ date }}</div>
                    </div>

                    <div class="character-info">
                        <div class="label">ä»Šæ—¥äº‹ä»¶</div>
                        <div class="value" id="startEvents">åŠ è½½ä¸­...</div>
                    </div>

                    <button class="start-btn" id="startBtn" onclick="startExperience()">
                        å¼€å§‹ä½“éªŒ
                    </button>
                </div>

                <!-- è§†é¢‘åŒºåŸŸ -->
                <div class="video-container" id="videoContainer" style="display: none;">
                    <video id="videoPlayer" playsinline webkit-playsinline></video>
                    <!-- ç»“å±€å­—å¹• - åœ¨è§†é¢‘å®¹å™¨å†…ã€è§†é¢‘ä¸‹æ–¹ -->
                    <div class="ending-section" id="endingSection" style="display: none;">
                        <h2 class="ending-title" id="endingTitle">ç»“å±€æ ‡é¢˜</h2>
                        <p class="ending-text" id="endingText">ç»“å±€æè¿°...</p>
                    </div>
                </div>

                <!-- é€‰é¡¹åŒºåŸŸ - åœ¨ä¸Šé¢ -->
                <div class="choices-section" id="choicesSection" style="display: none;">
                    <!-- é€‰é¡¹æŒ‰é’®å°†ç”± JavaScript ç”Ÿæˆ -->
                </div>

                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ - æ‚¬æµ®é€æ˜ï¼Œåœ¨é€‰é¡¹ä¸‹æ–¹ -->
                <div class="progress-dots" id="progressDots" style="display: none;">
                    <!-- è¿›åº¦ç‚¹å°†ç”± JavaScript ç”Ÿæˆ -->
                </div>

                <!-- å‰§æƒ…ä¿¡æ¯ - åœ¨æœ€ä¸‹é¢ -->
                <div class="story-section" id="storySection" style="display: none;">
                    <div class="story-header">
                        <span class="event-time" id="eventTime">--:--</span>
                        <span class="event-type-badge" id="eventTypeBadge">N</span>
                    </div>
                    <h2 class="story-title" id="storyTitle">äº‹ä»¶åç§°</h2>
                    <p class="story-text" id="storyText">äº‹ä»¶æè¿°...</p>
                </div>

                <!-- ç»§ç»­æŒ‰é’® - å·²éšè— -->
                <button class="continue-btn" id="continueBtn">
                    ç»§ç»­
                </button>

                <!-- å®Œæˆç•Œé¢ -->
                <div class="complete-screen" id="completeScreen" style="display: none;">
                    <div class="emoji">ğŸ‰</div>
                    <h2>ä½“éªŒå®Œæˆ</h2>
                    <div class="final-stats">
                        <div class="stat-item">
                            <span class="stat-label">æœ€ç»ˆèƒ½é‡</span>
                            <span class="stat-value" id="finalEnergy">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœ€ç»ˆå¿ƒæƒ…</span>
                            <span class="stat-value" id="finalMood">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">äº²å¯†åº¦</span>
                            <span class="stat-value" id="finalIntimacy">--</span>
                        </div>
                    </div>
                    <button class="start-btn" onclick="location.reload()">
                        é‡æ–°å¼€å§‹
                    </button>
                </div>

                <!-- åŠ è½½ç•Œé¢ -->
                <div class="loading" id="loadingScreen" style="display: none;">
                    <div class="spinner"></div>
                    <p style="color: #8e8e93;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentVideos = [];
        let currentVideoIndex = 0;
        let currentEvent = null;
        let currentEventIndex = 0;
        let totalEvents = 0;
        let userData = null;
        let availableCharacters = [];
        let availableDates = [];       // æ—¥æœŸåˆ—è¡¨ï¼ˆå®Œæ•´æ•°æ®ï¼ŒåŒ…å«dir_nameç­‰ï¼‰
        let selectedCharacter = null;
        let selectedDate = null;        // é€‰ä¸­çš„æ—¥æœŸç›®å½•å
        let characterDateMap = {};      // è§’è‰²-æ—¥æœŸæ˜ å°„å…³ç³»
        let currentPhoneSize = 'video'; // å½“å‰æ‰‹æœºå°ºå¯¸ï¼ˆé»˜è®¤è§†é¢‘ä¼˜å…ˆï¼‰

        // ==================== æ‰‹æœºå°ºå¯¸é€‰æ‹©åŠŸèƒ½ ====================

        function toggleSizeMenu() {
            const panel = document.getElementById('sizeMenuPanel');
            panel.classList.toggle('active');
        }

        function selectPhoneSize(size) {
            currentPhoneSize = size;
            const phoneFrame = document.querySelector('.phone-frame');

            // ç§»é™¤æ‰€æœ‰å°ºå¯¸ç±»
            phoneFrame.classList.remove(
                'size-iphone4', 'size-iphone5', 'size-iphone6', 'size-iphone6plus',
                'size-iphonex', 'size-iphonexr', 'size-iphone12', 'size-iphone12pm',
                'size-iphone14pro', 'size-iphone15pm', 'size-android', 'size-video', 'size-full'
            );

            // æ·»åŠ æ–°å°ºå¯¸ç±»
            phoneFrame.classList.add('size-' + size);

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.size-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.size === size) {
                    option.classList.add('selected');
                }
            });

            // å…³é—­èœå•
            document.getElementById('sizeMenuPanel').classList.remove('active');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å°ºå¯¸èœå•
        document.addEventListener('click', function(e) {
            const menuBtn = document.querySelector('.size-menu-btn');
            const menuPanel = document.getElementById('sizeMenuPanel');

            if (!menuBtn.contains(e.target) && !menuPanel.contains(e.target)) {
                menuPanel.classList.remove('active');
            }
        });

        // ==================== é€‰æ‹©å™¨åŠŸèƒ½ ====================

        function toggleSelector() {
            const panel = document.getElementById('selectorPanel');
            const isActive = panel.classList.toggle('active');
            // æ‰“å¼€é¢æ¿æ—¶é‡ç½®æ‰€æœ‰è¿‡æ»¤çŠ¶æ€
            if (isActive) {
                resetFilters();
            }
        }

        async function loadSelectorData() {
            try {
                const response = await fetch('/api/selector-data');
                const data = await response.json();
                availableCharacters = data.characters || [];
                availableDates = data.dates || [];
                characterDateMap = data.character_date_map || {};

                // æ¸²æŸ“è§’è‰²åˆ—è¡¨
                const characterGrid = document.getElementById('characterGrid');
                characterGrid.innerHTML = '';
                availableCharacters.forEach(char => {
                    const item = document.createElement('div');
                    item.className = 'selector-item' + (selectedCharacter === char.id ? ' selected' : '');
                    item.dataset.charId = char.id;
                    item.innerHTML = `
                        <div class="selector-item-name">${char.name}</div>
                        <div class="selector-item-date">${char.id}</div>
                    `;
                    item.onclick = () => selectCharacter(char);
                    characterGrid.appendChild(item);
                });

                // æ¸²æŸ“æ—¥æœŸåˆ—è¡¨
                const dateGrid = document.getElementById('dateGrid');
                dateGrid.innerHTML = '';
                availableDates.forEach(date => {
                    const item = document.createElement('div');
                    item.className = 'selector-item' + (selectedDate === date.dir_name ? ' selected' : '');
                    item.dataset.dirName = date.dir_name;
                    item.dataset.charId = date.char_id || '';
                    item.innerHTML = `<div class="selector-item-name">${date.date}</div>`;
                    item.onclick = () => selectDate(date);
                    dateGrid.appendChild(item);
                });

                // åˆå§‹çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰æ—¥æœŸéƒ½æ˜¯ç°è‰²çš„
                initFilters();
            } catch (error) {
                console.error('åŠ è½½é€‰æ‹©æ•°æ®å¤±è´¥:', error);
            }
        }

        function selectCharacter(char) {
            selectedCharacter = char.id;
            // æ¸…é™¤æ—¥æœŸé€‰æ‹©ï¼ˆå› ä¸ºé€‰æ‹©çš„è§’è‰²å¯èƒ½æ²¡æœ‰å½“å‰é€‰ä¸­çš„æ—¥æœŸï¼‰
            selectedDate = null;
            renderSelectorItems();
            // æ ¹æ®é€‰æ‹©çš„è§’è‰²è¿‡æ»¤æ—¥æœŸ
            filterDatesByCharacter(char.id);
            updateConfirmButton();
        }

        function selectDate(date) {
            // åªæœ‰åœ¨å·²é€‰æ‹©è§’è‰²çš„æƒ…å†µä¸‹æ‰èƒ½é€‰æ‹©æ—¥æœŸ
            if (!selectedCharacter) {
                return;
            }
            selectedDate = date.dir_name;
            renderSelectorItems();
            updateConfirmButton();
        }

        // æ ¹æ®é€‰æ‹©çš„è§’è‰²è¿‡æ»¤æ—¥æœŸåˆ—è¡¨
        function filterDatesByCharacter(charId) {
            const dateItems = document.querySelectorAll('#dateGrid .selector-item');
            dateItems.forEach(item => {
                const itemCharId = item.dataset.charId;
                if (!itemCharId || itemCharId !== charId) {
                    item.classList.add('disabled');
                    item.style.opacity = '0.3';
                    item.style.pointerEvents = 'none';
                } else {
                    item.classList.remove('disabled');
                    item.style.opacity = '';
                    item.style.pointerEvents = '';
                }
            });
        }

        // é‡ç½®æ‰€æœ‰è¿‡æ»¤çŠ¶æ€
        // åˆå§‹çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰æ—¥æœŸéƒ½æ˜¯ç°è‰²çš„
        function resetFilters() {
            const characterItems = document.querySelectorAll('#characterGrid .selector-item');
            characterItems.forEach(item => {
                item.classList.remove('disabled');
                item.style.opacity = '';
                item.style.pointerEvents = '';
            });

            // æ‰€æœ‰æ—¥æœŸåˆå§‹éƒ½æ˜¯ç°è‰²çš„
            const dateItems = document.querySelectorAll('#dateGrid .selector-item');
            dateItems.forEach(item => {
                item.classList.add('disabled');
                item.style.opacity = '0.3';
                item.style.pointerEvents = 'none';
            });
        }

        // åˆå§‹åŠ è½½æ—¶ï¼Œæ‰€æœ‰æ—¥æœŸéƒ½æ˜¯ç°è‰²çš„
        function initFilters() {
            const dateItems = document.querySelectorAll('#dateGrid .selector-item');
            dateItems.forEach(item => {
                item.classList.add('disabled');
                item.style.opacity = '0.3';
                item.style.pointerEvents = 'none';
            });
        }

        function renderSelectorItems() {
            const characterItems = document.querySelectorAll('#characterGrid .selector-item');
            characterItems.forEach(item => {
                const itemCharId = item.dataset.charId;
                if (itemCharId === selectedCharacter) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });

            const dateItems = document.querySelectorAll('#dateGrid .selector-item');
            dateItems.forEach(item => {
                const itemDirName = item.dataset.dirName;
                if (itemDirName === selectedDate) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = !(selectedCharacter && selectedDate);
        }

        async function confirmSelection() {
            if (!selectedCharacter || !selectedDate) {
                return;
            }

            try {
                const response = await fetch('/api/load-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        character_id: selectedCharacter,
                        date: selectedDate
                    })
                });
                const data = await response.json();

                if (data.error) {
                    alert('æ•°æ®åŠ è½½å¤±è´¥: ' + data.error);
                    return;
                }

                // å…³é—­é€‰æ‹©å™¨
                document.getElementById('selectorPanel').classList.remove('active');

                // é‡ç½®çŠ¶æ€
                resetAllState();

                // é‡æ–°åˆå§‹åŒ–
                await init();

            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        function resetAllState() {
            currentVideos = [];
            currentVideoIndex = 0;
            currentEvent = null;
            currentEventIndex = 0;
            totalEvents = 0;
            userData = null;
            showingEnding = false;
            pendingEnding = null;
            if (endingTimer) {
                clearTimeout(endingTimer);
                endingTimer = null;
            }
            // ç§»é™¤è§†é¢‘æ¨¡ç³Šæ•ˆæœ
            document.getElementById('videoContainer').classList.remove('freeze-blur');
        }

        // ==================== ç”¨æˆ·æ¨¡å¼åŠŸèƒ½ ====================

        function switchToDebugMode() {
            window.location.href = '/';
        }

        function showLoading() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function hideAllSections() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('storySection').style.display = 'none';
            document.getElementById('choicesSection').style.display = 'none';
            document.getElementById('continueBtn').style.display = 'none';
            document.getElementById('endingSection').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'none';
            document.getElementById('progressDots').style.display = 'none';
            // ç§»é™¤è§†é¢‘æ¨¡ç³Šæ•ˆæœ
            document.getElementById('videoContainer').classList.remove('freeze-blur');
        }

        let showingEnding = false;  // æ ‡è®°æ˜¯å¦æ­£åœ¨æ˜¾ç¤ºç»“å±€
        let endingTimer = null;  // ç»“å±€æ˜¾ç¤ºè®¡æ—¶å™¨
        let pendingEnding = null;  // ç­‰å¾…æ˜¾ç¤ºçš„ç»“å±€

        // ==================== çŠ¶æ€æ›´æ–°åŠŸèƒ½ ====================

        async function updateStatusBar() {
            try {
                const response = await fetch('/api/state');
                const data = await response.json();

                if (data.error) return;

                // æ›´æ–°è§’è‰²å
                document.getElementById('statusCharacter').textContent = data.character || 'æœªçŸ¥';

                // æ›´æ–°å¿ƒæƒ…
                const moodMap = {
                    'Happy': 'ğŸ˜Š å¼€å¿ƒ',
                    'Neutral': 'ğŸ˜ å¹³é™',
                    'Sad': 'ğŸ˜¢ éš¾è¿‡',
                    'Excited': 'ğŸ¤© å…´å¥‹',
                    'Angry': 'ğŸ˜  ç”Ÿæ°”',
                    'Worried': 'ğŸ˜Ÿ æ‹…å¿ƒ',
                    'Relaxed': 'ğŸ˜Œ æ”¾æ¾',
                    'Tired': 'ğŸ˜´ ç–²æƒ«'
                };
                const moodDisplay = moodMap[data.mood] || data.mood || 'å¹³é™';
                document.getElementById('statusMoodBadge').textContent = moodDisplay;

                // æ›´æ–°èƒ½é‡
                document.getElementById('statusEnergy').textContent = data.energy || 100;

                // æ›´æ–°äº²å¯†åº¦
                document.getElementById('statusIntimacy').textContent = data.intimacy || 0;

            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ==================== ç”¨æˆ·æ¨¡å¼åŠŸèƒ½ ====================

        async function init() {
            showLoading();
            try {
                const response = await fetch('/api/user/init');
                const data = await response.json();

                if (data.error) {
                    hideLoading();
                    return;
                }

                userData = data;
                totalEvents = data.total_events;

                document.getElementById('startCharacter').textContent = data.character;
                document.getElementById('startDate').textContent = data.date;
                document.getElementById('startEvents').textContent = `${data.total_events} ä¸ªäº‹ä»¶`;

                // æ›´æ–°çŠ¶æ€æ 
                await updateStatusBar();

                hideLoading();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                hideLoading();
            }
        }

        async function startExperience() {
            hideAllSections();
            showLoading();
            await loadNextEvent();
        }

        async function loadNextEvent() {
            try {
                const response = await fetch('/api/user/next-event');
                const data = await response.json();

                if (data.completed) {
                    showComplete();
                    return;
                }

                currentEvent = data;
                currentEventIndex = data.index;

                displayEvent(data);
                updateProgressDots();

            } catch (error) {
                console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
            }
        }

        function displayEvent(data) {
            hideAllSections();

            // æ¸…é™¤ç»“å±€è®¡æ—¶å™¨å’ŒçŠ¶æ€
            if (endingTimer) {
                clearTimeout(endingTimer);
                endingTimer = null;
            }
            showingEnding = false;
            pendingEnding = null;

            // æ›´æ–°çŠ¶æ€æ ï¼ˆè·å–æœ€æ–°å±æ€§ï¼‰
            updateStatusBar();

            // ç§»é™¤è§†é¢‘æ¨¡ç³Šæ•ˆæœ
            document.getElementById('videoContainer').classList.remove('freeze-blur');

            // å…ˆæ˜¾ç¤ºå‰§æƒ…ä¿¡æ¯
            document.getElementById('storySection').style.display = 'block';
            document.getElementById('eventTime').textContent = data.time_slot;
            document.getElementById('storyTitle').textContent = data.event_name;
            document.getElementById('storyText').textContent = data.summary || '';

            const badge = document.getElementById('eventTypeBadge');
            badge.textContent = data.event_type;
            badge.className = 'event-type-badge type-' + data.event_type.toLowerCase();

            // æ˜¾ç¤ºè§†é¢‘
            if (data.videos && data.videos.length > 0) {
                currentVideos = data.videos;
                currentVideoIndex = 0;
                document.getElementById('videoContainer').style.display = 'block';
                playVideo(0);
            } else {
                // æ²¡æœ‰è§†é¢‘ï¼ŒR/SRäº‹ä»¶ç›´æ¥åŠ è½½é€‰é¡¹
                if (data.event_type === 'R' || data.event_type === 'SR') {
                    loadChoices();
                }
            }

            hideLoading();
        }

        function playVideo(index) {
            if (index >= currentVideos.length) {
                onVideoSequenceComplete();
                return;
            }

            currentVideoIndex = index;
            const player = document.getElementById('videoPlayer');
            const videoUrl = currentVideos[index];
            const isLastVideo = (index === currentVideos.length - 1);

            player.onended = () => {
                if (index + 1 < currentVideos.length) {
                    playVideo(index + 1);
                } else {
                    // æœ€åä¸€ä¸ªè§†é¢‘æ’­æ”¾å®Œæ¯•
                    if (pendingEnding) {
                        // æœ‰å¾…æ˜¾ç¤ºçš„ç»“å±€
                        displayEnding(pendingEnding);
                        pendingEnding = null;
                    } else {
                        onVideoSequenceComplete();
                    }
                }
            };

            player.onerror = () => {
                if (index + 1 < currentVideos.length) {
                    playVideo(index + 1);
                } else {
                    if (pendingEnding) {
                        displayEnding(pendingEnding);
                        pendingEnding = null;
                    } else {
                        onVideoSequenceComplete();
                    }
                }
            };

            player.src = videoUrl;
            player.load();
            player.play().catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
        }

        async function onVideoSequenceComplete() {
            document.getElementById('videoContainer').style.display = 'none';

            if (!currentEvent) return;

            if (currentEvent.event_type === 'N') {
                // Näº‹ä»¶ï¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶
                await continueToNext();
            } else {
                // R/SRäº‹ä»¶ï¼šåŠ è½½é€‰é¡¹
                await loadChoices();
            }
        }

        async function loadChoices() {
            try {
                const response = await fetch('/api/user/choices');
                const data = await response.json();

                if (data.completed) {
                    // æ‰€æœ‰é˜¶æ®µå®Œæˆï¼Œè‡ªåŠ¨è·³è½¬ä¸‹ä¸€ä¸ªäº‹ä»¶
                    await continueToNext();
                    return;
                }

                if (data.narrative_video) {
                    // æœ‰å™äº‹è§†é¢‘ï¼Œæ’­æ”¾å®ƒ
                    document.getElementById('videoContainer').style.display = 'block';
                    const player = document.getElementById('videoPlayer');

                    // ä¿å­˜é€‰é¡¹æ•°æ®ï¼Œç­‰å™äº‹è§†é¢‘æ’­æ”¾å®Œæ¯•åå†æ˜¾ç¤º
                    const choicesData = data.choices || [];

                    player.onended = () => {
                        document.getElementById('videoContainer').style.display = 'none';
                        // å™äº‹è§†é¢‘æ’­æ”¾å®Œæ¯•ï¼Œæ˜¾ç¤ºé€‰é¡¹
                        if (choicesData.length > 0) {
                            displayChoices(choicesData);
                        } else {
                            // æ²¡æœ‰é€‰é¡¹ï¼Œç»§ç»­åŠ è½½ä¸‹ä¸€é˜¶æ®µ
                            loadChoices();
                        }
                    };

                    player.src = data.narrative_video;
                    player.load();
                    player.play().catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
                } else {
                    // æ²¡æœ‰å™äº‹è§†é¢‘ï¼Œç›´æ¥æ˜¾ç¤ºé€‰é¡¹
                    if (data.choices && data.choices.length > 0) {
                        displayChoices(data.choices);
                    }
                }

            } catch (error) {
                console.error('åŠ è½½é€‰é¡¹å¤±è´¥:', error);
            }
        }

        function displayChoices(choices) {
            const container = document.getElementById('choicesSection');
            container.innerHTML = '';

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn fade-in';
                btn.innerHTML = `
                    <div class="choice-id">${choice.id}</div>
                    <div class="choice-tag">${choice.tag}</div>
                    <div class="choice-action">${choice.action}</div>
                `;
                btn.onclick = () => makeChoice(choice.id);
                container.appendChild(btn);
            });

            container.style.display = 'block';
        }

        async function makeChoice(choiceId) {
            document.getElementById('choicesSection').style.display = 'none';
            showLoading();

            try {
                const response = await fetch('/api/user/choice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({choice_id: choiceId})
                });
                const data = await response.json();

                hideLoading();

                if (data.branch_videos && data.branch_videos.length > 0) {
                    document.getElementById('videoContainer').style.display = 'block';
                    currentVideos = data.branch_videos;

                    // è®¾ç½®å¾…æ˜¾ç¤ºçš„ç»“å±€ï¼ˆå¦‚æœæœ‰ï¼‰
                    pendingEnding = data.ending || null;
                    playVideo(0);
                } else if (data.ending) {
                    // æ²¡æœ‰è§†é¢‘ä½†æœ‰ç»“å±€ï¼Œç›´æ¥æ˜¾ç¤ºç»“å±€
                    displayEnding(data.ending);
                }

            } catch (error) {
                console.error('é€‰æ‹©å¤±è´¥:', error);
                hideLoading();
            }
        }

        function displayEnding(ending) {
            showingEnding = true;

            // è·å–è§†é¢‘å®¹å™¨å’Œæ’­æ”¾å™¨
            const videoContainer = document.getElementById('videoContainer');
            const player = document.getElementById('videoPlayer');

            // æ·»åŠ æ¨¡ç³Šæ•ˆæœåˆ°è§†é¢‘ï¼ˆå®šæ ¼åœ¨æœ€åä¸€å¸§ï¼‰
            videoContainer.classList.add('freeze-blur');
            player.pause(); // æš‚åœè§†é¢‘ä»¥å®šæ ¼

            // ç¡®ä¿è§†é¢‘å®¹å™¨å¯è§
            videoContainer.style.display = 'block';

            // æ˜¾ç¤ºç»“å±€å­—å¹•ï¼ˆåœ¨è§†é¢‘ä¸‹æ–¹ï¼‰
            document.getElementById('endingSection').style.display = 'block';
            document.getElementById('endingTitle').textContent = ending.title;
            document.getElementById('endingText').textContent = ending.plot_closing;

            // æ›´æ–°çŠ¶æ€æ ï¼ˆæ˜¾ç¤ºå±æ€§å˜åŒ–åçš„çŠ¶æ€ï¼‰
            updateStatusBar();

            // 4ç§’åè‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶
            if (endingTimer) clearTimeout(endingTimer);
            endingTimer = setTimeout(() => {
                showingEnding = false;
                // ç§»é™¤æ¨¡ç³Šæ•ˆæœ
                videoContainer.classList.remove('freeze-blur');
                continueToNext();
            }, 4000);
        }

        async function continueToNext() {
            // æ¸…é™¤ç»“å±€è®¡æ—¶å™¨å’ŒçŠ¶æ€
            if (endingTimer) {
                clearTimeout(endingTimer);
                endingTimer = null;
            }
            showingEnding = false;
            pendingEnding = null;

            showLoading();

            try {
                const response = await fetch('/api/user/continue');
                const data = await response.json();

                if (data.completed) {
                    showComplete();
                    return;
                }

                currentEvent = data;
                currentEventIndex = data.index;
                displayEvent(data);
                updateProgressDots();

            } catch (error) {
                console.error('ç»§ç»­å¤±è´¥:', error);
                hideLoading();
            }
        }

        async function showComplete() {
            hideAllSections();

            // è·å–æœ€æ–°çŠ¶æ€
            try {
                const response = await fetch('/api/state');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('finalEnergy').textContent = data.energy || 100;
                    document.getElementById('finalMood').textContent = data.mood || 'Neutral';
                    document.getElementById('finalIntimacy').textContent = data.intimacy || 0;
                } else {
                    document.getElementById('finalEnergy').textContent = userData?.energy || 100;
                    document.getElementById('finalMood').textContent = userData?.mood || 'Neutral';
                    document.getElementById('finalIntimacy').textContent = 0;
                }
            } catch (error) {
                document.getElementById('finalEnergy').textContent = userData?.energy || 100;
                document.getElementById('finalMood').textContent = userData?.mood || 'Neutral';
                document.getElementById('finalIntimacy').textContent = 0;
            }

            document.getElementById('completeScreen').style.display = 'flex';
            hideLoading();
        }

        function updateProgressDots() {
            const container = document.getElementById('progressDots');
            container.innerHTML = '';
            container.style.display = 'flex';

            for (let i = 0; i < totalEvents; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (i < currentEventIndex) {
                    dot.classList.add('completed');
                } else if (i === currentEventIndex) {
                    dot.classList.add('active');
                }
                container.appendChild(dot);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
        loadSelectorData();
    </script>
</body>
</html>
